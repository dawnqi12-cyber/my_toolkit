<!DOCTYPE html>
<html>
<head>
    <title>图片处理工具</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .preview { max-width: 100%; margin: 20px 0; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>图片处理工具</h1>
    <form id="upload-form">
        <div>
            <label>选择图片：
                <input type="file" id="image" accept="image/*" required>
            </label>
        </div>
        <div>
            <label>宽度：<input type="number" name="width" value="800" min="100"></label>
            <label>高度：<input type="number" name="height" value="600" min="100"></label>
        </div>
        <div>
            <label><input type="checkbox" id="resize" checked> 缩放</label>
            <label><input type="checkbox" id="rotate_left"> 左旋90°</label>
            <label><input type="checkbox" id="rotate_right"> 右旋90°</label>
            <label><input type="checkbox" id="flip_horizontal"> 水平翻转</label>  <!-- 添加翻转复选框 -->
            <label><input type="checkbox" id="compress"> 压缩</label>
            <label>压缩质量：<input type="number" name="quality" value="80" min="0" max="100"></label>
        </div>
        <button type="button" id="process-btn">处理图片</button>
    </form>
    
    <div id="result">
        <div id="message" class=""></div>
        <img id="output-preview" class="preview" style="display: none;">
    </div>

    <script>
        document.getElementById("process-btn").onclick = async () => {
            const messageDiv = document.getElementById("message");
            messageDiv.textContent = "处理中...";
            messageDiv.className = "";

            const fileInput = document.getElementById("image");
            if (!fileInput.files[0]) {
                messageDiv.textContent = "请先选择图片";
                messageDiv.className = "error";
                return;
            }

            const formData = new FormData();
            formData.append("image", fileInput.files[0]);

            // 根据复选框决定是否添加操作参数
            if (document.getElementById("resize").checked) {
                formData.append("resize", "true");
                formData.append("width", document.querySelector("input[name='width']").value);
                formData.append("height", document.querySelector("input[name='height']").value);
            }
            if (document.getElementById("rotate_left").checked) {
                formData.append("rotate_left", "true");
            }
            if (document.getElementById("rotate_right").checked) {
                formData.append("rotate_right", "true");
            }
            if (document.getElementById("flip_horizontal").checked) {  // 添加翻转参数
                formData.append("flip_horizontal", "true");
            }
            if(document.getElementById("compress").checked) {
                formData.append("compress", "true");
                formData.append("quality", document.querySelector("input[name='quality']").value);
            }

            try {
                const response = await fetch("/process", {
                    method: "POST",
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    const img = document.getElementById("output-preview");
                    img.src = data.result_url + "?t=" + new Date().getTime();
                    img.style.display = "block";
                    messageDiv.textContent = "处理成功！";
                    messageDiv.className = "success";
                } else {
                    messageDiv.textContent = `错误: ${data.error}`;
                    messageDiv.className = "error";
                }
            } catch (err) {
                messageDiv.textContent = `请求失败: ${err}`;
                messageDiv.className = "error";
                console.error(err);
            }
        };
    </script>
</body>
</html>